{% extends "admin/base.html" %}

{% block title %}{% if car %}차량 수정{% else %}차량 추가{% endif %}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">{% if car %}차량 수정{% else %}차량 추가{% endif %}</h1>
    <a href="{{ url_for('admin_cars') }}" class="btn btn-outline-secondary">
        <i class="fas fa-arrow-left me-2"></i>목록으로
    </a>
</div>

<div class="row">
    <div class="col-lg-8">
        <form method="POST" action="{{ url_for('admin_car_save') }}" enctype="multipart/form-data">
            {% if car %}
                <input type="hidden" name="car_id" value="{{ car.id }}">
            {% endif %}
            
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">차량 정보</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="name" class="form-label">차량명</label>
                        <input type="text" class="form-control" id="name" name="name" 
                               value="{{ car.name if car else '' }}" required>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="price_2h" class="form-label">공항픽업/2시간 요금 (VND)</label>
                            <input type="number" class="form-control" id="price_2h" name="price_2h" 
                                   value="{{ car.price_2h if car else '' }}" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="price_4h" class="form-label">4시간 요금 (VND)</label>
                            <input type="number" class="form-control" id="price_4h" name="price_4h" 
                                   value="{{ car.price_4h if car else '' }}" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="price_8h" class="form-label">8시간 요금 (VND)</label>
                            <input type="number" class="form-control" id="price_8h" name="price_8h" 
                                   value="{{ car.price_8h if car else '' }}" required>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="description" class="form-label">차량 설명</label>
                        <textarea class="form-control" id="description" name="description" rows="4">{{ car.description if car else '' }}</textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="images" class="form-label">차량 이미지</label>
                        <input type="file" class="form-control" id="images" name="images" 
                               multiple accept="image/*">
                        <div class="form-text">
                            여러 이미지를 선택할 수 있습니다. (JPG, PNG, GIF, WebP)
                        </div>
                    </div>
                    
                    {% if car and car.get_images_list() %}
                        <div class="mb-3">
                            <label class="form-label">현재 이미지</label>
                            <div class="row">
                                {% for image in car.get_images_list() %}
                                    <div class="col-md-3 mb-2">
                                        <img src="{{ url_for('static', filename='uploads/' + image) }}" 
                                             class="img-thumbnail" alt="차량 이미지">
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    {% endif %}
                </div>
                
                <div class="card-footer">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>저장
                    </button>
                    <a href="{{ url_for('admin_cars') }}" class="btn btn-secondary ms-2">취소</a>
                </div>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const imageInput = document.getElementById('images');
    const form = document.querySelector('form');
    const submitBtn = document.querySelector('button[type="submit"]');

    // 파일 선택 시 미리보기 표시
    imageInput.addEventListener('change', function(e) {
        const files = e.target.files;
        if (files.length > 0) {
            // 선택된 파일 수 표시
            const fileCount = files.length;
            const fileNames = Array.from(files).map(file => file.name).join(', ');

            // 기존 미리보기 영역이 있다면 제거
            const existingPreview = document.querySelector('.image-preview');
            if (existingPreview) {
                existingPreview.remove();
            }

            // 새로운 미리보기 영역 생성
            const previewDiv = document.createElement('div');
            previewDiv.className = 'image-preview mt-3';
            previewDiv.innerHTML = `
                <label class="form-label">선택된 이미지 (${fileCount}개)</label>
                <div class="row" id="imagePreviewContainer"></div>
            `;

            // 파일 입력 필드 다음에 미리보기 추가
            imageInput.parentNode.insertBefore(previewDiv, imageInput.nextSibling);

            // 각 파일에 대한 미리보기 생성
            Array.from(files).forEach((file, index) => {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const previewContainer = document.getElementById('imagePreviewContainer');
                        const col = document.createElement('div');
                        col.className = 'col-md-3 mb-2';
                        col.innerHTML = `
                            <div class="position-relative">
                                <img src="${e.target.result}" class="img-thumbnail" alt="미리보기 ${index + 1}" style="width: 100%; height: 150px; object-fit: cover;">
                                <button type="button" class="btn btn-sm btn-danger position-absolute top-0 end-0" onclick="removePreview(this)" style="margin: 5px;">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <small class="text-muted d-block">${file.name}</small>
                        `;
                        previewContainer.appendChild(col);
                    };
                    reader.readAsDataURL(file);
                }
            });
        }
    });

    // 폼 제출 시 로딩 상태 표시
    form.addEventListener('submit', function(e) {
        const files = imageInput.files;
        if (files.length > 0) {
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>업로드 중...';

            // 파일 크기 검증 (16MB 제한)
            let totalSize = 0;
            for (let file of files) {
                totalSize += file.size;
            }

            if (totalSize > 16 * 1024 * 1024) { // 16MB
                e.preventDefault();
                alert('총 파일 크기가 16MB를 초과합니다. 파일을 분할하여 업로드해주세요.');
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-save me-2"></i>저장';
                return;
            }
        }
    });

    // 미리보기 제거 함수
    window.removePreview = function(button) {
        const col = button.closest('.col-md-3');
        col.remove();

        // 남은 미리보기 수 업데이트
        const remainingPreviews = document.querySelectorAll('#imagePreviewContainer .col-md-3');
        if (remainingPreviews.length === 0) {
            const previewDiv = document.querySelector('.image-preview');
            if (previewDiv) {
                previewDiv.remove();
            }
            // 파일 입력 초기화
            imageInput.value = '';
        } else {
            const label = document.querySelector('.image-preview .form-label');
            if (label) {
                label.textContent = `선택된 이미지 (${remainingPreviews.length}개)`;
            }
        }
    };
});
</script>
{% endblock %}
